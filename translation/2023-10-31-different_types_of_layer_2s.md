# 不同类型的 layer 2
> 原文链接：[https://vitalik.ca/general/2023/10/31/l2types.html](https://vitalik.ca/general/2023/10/31/l2types.html)

_特别感谢 Karl Floersch 的反馈和审阅_

过去一年，以太坊 layer 2 生态系统迅速扩张。传统上以 EVM rollup 生态系统为特色，包括 [Arbitrum](https://arbitrum.io/)、[Optimism](https://optimism.io/)和 [Scroll](https://scroll.io/)，最近还有 [Kakarot](https://www.kakarot.org/)和 [Taiko](https://taiko.xyz/)，这些项目取得了快速进展，大大提高了安全性；[L2beat 页面](https://l2beat.com/scaling/summary)很好地总结了每个项目的状态。此外，我们还看到一些团队正在构建侧链，也开始构建 rollups（[Polygon](https://polygon.technology/)），一些层 1 项目希望向 validiums 转变（[Celo](https://celo.org/)），以及全新的努力（[Linea](https://linea.build/)，[Zeth](https://www.risczero.com/news/zeth-release)...）。最后，还有非 EVM 生态系统：像 [Zksync](https://zksync.io/)这样的“几乎 EVM”以及 [Arbitrum Stylus](https://docs.arbitrum.io/stylus/stylus-gentle-introduction)这样的扩展，以及 [Starknet 生态系统](https://www.starknet.io/en)、[Fuel](https://www.fuel.network/) 等更广泛的努力。

这带来的一个不可避免的结果是，我们看到 layer 2 项目变得更加异质化的趋势。我预计这种趋势会继续，原因有几个：

- **一些当前独立的 layer 1 项目希望更接近以太坊生态系统，并可能成为 layer 2。** 这些项目可能希望逐步过渡。现在一次性过渡会导致可用性下降，因为技术尚未准备好将所有内容放在 rollup 上。稍后一次性过渡会冒着牺牲动力并且为时已晚的风险。
- **一些中心化项目希望为其用户提供更多安全保障，并正在探索基于区块链的途径。** 在许多情况下，这些是以前可能会探索“许可的财团链”的项目。实际上，它们可能只需要一定程度的分散化。此外，它们通常具有非常高的吞吐量，即使在短期内也不适合 rollups。
- **非金融应用程序，如游戏或社交媒体，希望是*分散化*，但只需要一定程度的*安全性*。** 在社交媒体的情况下，这实际上涉及以不同方式处理应用程序的不同部分：像用户名注册和账户恢复这样的罕见且高价值的活动应该在 rollup 上完成，而像帖子和投票这样频繁且低价值的活动则需要更少的安全性。如果链的失败导致你的帖子消失，那是可以接受的代价。如果链的失败导致你丢失账户，那将是一个更大的问题。

一个重要的主题是，虽然今天在以太坊 layer 1 上的应用程序和**用户**在短期内支付较小但仍然可见的 rollup 费用是可以接受的，**来自非区块链世界的用户**不会：如果之前支付了 $1，现在支付 $0.10 更容易被接受，而如果之前支付了 $0，现在支付 $0.10 就不容易被接受。这既适用于今天中心化的应用程序，也适用于较小的 layer 1 ，尽管它们的用户基数仍然很小，但通常费用非常低。

一个自然而然的问题是：在给定应用程序的情况下，rollups、validiums 和其他系统之间的这些复杂权衡中，哪种类型的选择对其有意义？

## Rollups vs validiums vs 断开的系统

我们将要探讨的安全性与规模的第一个维度可以描述如下：**如果你拥有在 L1 上发行的资产，然后存入 L2，然后转移到你的资产，你有多大的保证能够将资产带回 L1？**

还有一个类似的问题：导致这种保证水平的技术选择是什么，以及这种技术选择的权衡是什么？

我们可以用一个表格简单描述：

   
| 系统类型 | 技术属性 | 安全性保证 | 成本 |
| --- | --- | --- | --- |
| **Rollup** | 通过欺诈证明或 ZK-SNARKs 证明计算，数据存储在 L1 上 | 你始终可以将资产带回 L1 | L1 数据可用性 + SNARK 证明或冗余执行以捕捉错误 |
| **Validium** | 通过 ZK-SNARKs 证明计算（无法使用欺诈证明），数据存储在服务器或其他独立系统上 | 数据可用性故障可能导致资产丢失，但不会被盗 | SNARK 证明 |
| **断开的** | 单独的链（或服务器） | 信任一个或一小群人不会盗取你的资金或丢失密钥 | 非常便宜 |

值得一提的是，**这是一个简化的模式，存在许多中间选项**。例如：

- **在 rollup 和 validium 之间**：一个 validium，任何人都可以在链上支付以支付交易费用，此时操作者将被迫在链上提供一些数据，否则将失去存款。
- **在 plasma 和 validium 之间**：[Plasma 系统](https://arxiv.org/abs/1911.12095)提供类似 rollup 的安全性保证，具有链下数据可用性，但仅支持有限数量的应用程序。一个系统*可以*提供完整的 EVM，并向不使用这些更复杂应用程序的用户提供类似 Plasma 级别的保证，并向使用这些应用程序的用户提供 validium 级别的保证。

这些中间选项可以被视为在 rollup 和 validium 之间的一种谱系。但是是什么促使应用程序选择谱系上的特定点，而不是更左边或更右边的某个点呢？在这里，有两个主要因素：

1. **以太坊本地数据可用性的成本，随着技术的改进而降低**。以太坊的下一个硬分叉 [Dencun](https://consensys.io/blog/ethereum-dencun-upgrade-explained-part-1)引入了 [EIP-4844](https://www.eip4844.com/)（又名“proto-danksharding”），提供每秒约 32 kB 的链上数据可用性。在接下来的几年里，预计随着[完整的 danksharding](https://hackmd.io/@vbuterin/sharding_proposal) 的推出，这将分阶段增加，最终目标约为每秒 1.3 MB 的数据可用性。同时，[数据压缩的改进](https://twitter.com/VitalikButerin/status/1554983955182809088)将使我们能够在相同数量的数据上做更多事情。
2. **应用程序自身的需求：用户会因高费用而遭受多大损失，而不是因为应用程序出现问题而遭受多大损失？** 金融应用程序会因应用程序故障而损失更多；游戏和社交媒体涉及每个用户的大量活动，相对低价值的活动，因此对于它们来说，不同的安全性权衡是有意义的。

大致上，这种权衡看起来是这样的：

![](https://vitalik.ca/images/l2types/rollup_vs_validium.png)

另一种值得一提的部分保证类型是**预确认**。预确认是由 rollup 或 validium 中一些参与者签名的消息，表示“我们证明这些交易包含在此顺序中，并且后状态根是这样的”。这些参与者很可能签署一个与稍后现实不符的预确认，但如果他们这样做，存款将被烧毁。这对于像消费者支付这样的低价值应用程序是有用的，而像数百万美元的金融转账这样的高价值应用程序很可能会等待由系统的全面安全性支持的“常规”确认。

**预确认可以被视为另一个混合系统的例子**，类似于上面提到的“plasma/validium 混合”，但这次是在具有全面安全性但延迟较高的 rollup（或 validium）和具有较低安全级别但延迟较低的系统之间进行混合。需要较低延迟的应用程序获得较低安全性，但可以与愿意为最大安全性而接受较高延迟的应用程序共存。

## 无需信任地*读取*以太坊

另一种不太被考虑但仍然非常重要的连接形式与**系统读取以太坊区块链的能力**有关。特别是，这包括**能够在以太坊回滚时进行回滚**。要了解为什么这很有价值，请考虑以下情况：

![](https://vitalik.ca/images/l2types/ethreverts.png)

假设，如图所示，以太坊链发生了回滚。这可能是在一个纪元内暂时的小问题，当链尚未最终确定时，或者可能是一个[不活跃泄漏](https://eth2book.info/capella/part2/incentives/inactivity/)期间，链在较长时间内未最终确定，因为太多验证者离线。

从这里可能出现的最坏情况如下。假设顶部链的第一个区块从顶部链的最左侧区块中读取了一些以太坊链上的数据。例如，有人在以太坊上存入 100 ETH 到顶部链。然后，以太坊发生回滚。然而，顶部链没有回滚。因此，顶部链的未来区块正确地跟随了新的正确的以太坊链上的区块，但是*现在错误的旧链接*（即 100 ETH 存款）仍然是顶部链的一部分。这种利用可能会导致货币的增发，将顶部链上的桥接 ETH 变成部分准备金。

解决这个问题有两种方法：

1. **顶部链只能读取以太坊的*最终确定*区块**，因此它永远不需要回滚。
2. **如果以太坊回滚，顶部链可以回滚**。两者都可以防止这个问题。前者更容易实现，但如果以太坊进入不活跃泄漏期，可能会导致较长时间的功能损失。后者更难实现，但始终确保最佳功能。

请注意，（1）确实有一个特例。如果以太坊发生 51%攻击，创建了两个新的不兼容区块，两者同时看起来都是最终确定的，那么顶部链很可能会锁定在错误的区块上（即以太坊社会共识最终不支持的区块），并且必须回滚以切换到正确的区块。可以说，没有必要提前编写处理此情况的代码；可以通过硬分叉顶部链来处理这个问题。

链无需信任地读取以太坊的能力有两个重要原因：

1. 减少了涉及将在以太坊（或其他 L2）上发行的代币桥接到该链上的安全问题
2. 允许使用[共享密钥库架构](https://vitalik.ca/general/2023/06/20/deeperdive.html)的账户抽象钱包在该链上安全地持有资产。

其中，1 是重要的，尽管可以说这种需求已经被广泛认可。2 也很重要，因为这意味着你可以拥有一个钱包，允许轻松更改密钥，并且在许多不同的链上持有资产。

## 拥有桥接是否意味着你是 validium？

假设顶部链最初是一个独立的链，然后有人在以太坊上放置了一个桥接合约。桥接合约只是接受顶部链的区块头，验证提交给它的任何区块头是否附带一个显示它已被顶部链共识接受的有效证书，并将该区块头添加到列表中。应用程序可以在此基础上构建功能，例如存入和提取代币。一旦有了这样的桥接，是否提供了我们之前提到的任何资产安全性保证呢？

![](https://vitalik.ca/images/l2types/bridge.png)

到目前为止，还没有！有两个原因：

1. 我们验证了区块被*签名*，但没有验证状态转换是否正确。因此，如果你在以太坊上发行的资产存入了顶部链，而顶部链的验证者变得不端，他们可以签署一个窃取这些资产的无效状态转换。
2. 顶部链仍然无法*读取*以太坊。因此，即使是将以太坊本地资产存入顶部链，也无法在不依赖于某些其他（可能不安全的）第三方桥接的情况下进行。

现在，让我们将桥接变成**验证桥接**：它不仅检查共识，还检查 ZK-SNARK 证明，证明任何新区块的状态是正确计算的。

一旦这样做了，顶部链的验证者就无法窃取你的资金。他们*可以*发布一个带有不可用数据的区块，阻止所有人提取，但他们无法窃取资金（除非试图勒索用户以换取向他们提供允许提取的数据）。这与 validium 的安全模型相同。然而，我们仍然没有解决第二个问题：顶层链无法读取以太坊。

为了解决这个问题，我们需要做以下两件事情之一：

1. 在顶层链中放置一个验证已完成以太坊区块的桥接合约。
2. 使顶层链中的每个区块包含最近以太坊区块的哈希，并制定一个分叉选择规则来强制执行哈希链接。也就是说，链接到非规范链上的以太坊区块的顶层链区块本身就是非规范的，如果顶层链区块链接到一开始是规范的以太坊区块，但后来变成了非规范的，那么顶层链区块也必须变成非规范的。

![](https://vitalik.ca/images/l2types/bridge2.png)

_紫色的链接可以是哈希链接，也可以是验证以太坊共识的桥接合约。_

这样就足够了吗？事实证明，还不够，因为还存在一些小的边缘情况：

1. 如果以太坊遭受了 51% 的攻击会发生什么？
2. 如何处理以太坊的硬分叉升级？
3. 如何处理你的链的硬分叉升级？

对以太坊进行 51% 攻击会产生与对顶层链进行 51% 攻击类似的后果，但是相反。以太坊的硬分叉可能会使顶层链内的以太坊桥不再有效。**如果以太坊回滚了一个已完成的区块，或者以太坊进行了硬分叉，社会承诺将回滚是解决这个问题的最干净的方式**。这样的承诺很可能永远不需要实际执行：你可以在顶层链上激活一个治理工具，如果它看到可能发生攻击或硬分叉的证据，只有在治理工具失败时才对顶层链进行硬分叉。

对于问题(3)的唯一可行的答案是，不幸的是，以太坊上必须有某种形式的治理工具，可以使以太坊上的桥接合约意识到顶层链的硬分叉升级。

**总结**：双向验证桥接几乎足以使链成为有效的验证链。主要剩下的要素是一种社会承诺，即如果以太坊发生了异常情况，使桥接不再有效，另一条链将做出硬分叉响应。

## 结论

“与以太坊的连接性”有两个关键维度：

1. 提取到以太坊的安全性
2. 读取以太坊的安全性

这两者都很重要，并且有不同的考虑因素。在每种情况下都存在一个范围：

![](https://vitalik.ca/images/l2types/4d.png)

请注意，每个维度都有两种不同的衡量方式（所以实际上有四个维度）：**提取的安全性**可以通过（i）安全级别和（ii）有多少用户或用例受益于最高安全级别来衡量，而**读取的安全性**可以通过（i）链有多快读取以太坊的区块，特别是已完成的区块与任何区块，以及（ii）链对处理 51%攻击和硬分叉等边缘情况的社会承诺的强度来衡量。

在这种设计空间中的项目都有价值。对于一些应用程序，高安全性和紧密的连接性很重要。对于其他应用程序，为了获得更大的可扩展性，可以接受一些较宽松的条件。在许多情况下，从今天开始使用较宽松的条件，并在未来十年随着技术的改进而逐渐过渡到更紧密的耦合可能是最佳选择。